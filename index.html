<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Professional Exam Experience</title>
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,500,700&display=swap" rel="stylesheet">
  <!-- Chart.js for analysis charts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --primary-color: #5c4ac7;
      --primary-dark: #4b3aa5;
      --secondary-color: #007bff;
      --background-color: #f9f9f9;
      --card-background: #ffffff;
      --dark-background: #121212;
      --dark-card-background: #1e1e1e;
      --text-color: #333;
      --light-text: #ffffff;
      --neutral-text: #777;
      --border-color: #ddd;
      --shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    /* Reset & Base */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: 'Roboto', sans-serif;
      background: var(--background-color);
      color: var(--text-color);
      line-height: 1.7;
      padding: 20px;
      transition: background 0.3s, color 0.3s;
    }
    body.dark-mode {
      background: var(--dark-background);
      color: #fff;
    }

    /* Sticky Header */
    .header {
      background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
      color: var(--light-text);
      padding: 20px 20px 10px;
      text-align: center;
      border-radius: 8px;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: var(--shadow);
      margin-bottom: 20px;
    }
    .header h1 {
      font-size: 2.2rem;
      margin-bottom: 8px;
    }
    .header .info {
      display: flex;
      justify-content: center;
      gap: 20px;
      font-size: 1rem;
    }
    body.dark-mode .header,
    body.dark-mode .header .info,
    body.dark-mode .header h1 {
      color: var(--light-text);
    }
    .dark-toggle, .fullscreen-toggle {
      position: absolute;
      top: 20px;
      font-size: 1.8rem;
      cursor: pointer;
      user-select: none;
      color: var(--light-text);
    }
    .dark-toggle {
      right: 20px;
    }
    .fullscreen-toggle {
      right: 60px;
    }

    /* Timer Bar */
    #timer-bar {
      height: 5px;
      background: var(--primary-dark);
      width: 100%;
      margin-top: 10px;
      border-radius: 3px;
      transition: width 0.5s;
    }

    /* Main Container */
    .container {
      background: var(--card-background);
      padding: 30px;
      border-radius: 8px;
      box-shadow: var(--shadow);
      max-width: 900px;
      margin: auto;
      transition: background 0.3s, color 0.3s;
    }
    body.dark-mode .container {
      background: var(--dark-card-background);
    }

    h2 {
      margin-bottom: 20px;
      font-size: 1.8rem;
      color: var(--primary-color);
      text-align: center;
    }
    body.dark-mode h2 {
      color: var(--light-text);
    }

    input, select, button, textarea {
      width: 100%;
      padding: 12px;
      margin: 10px 0;
      font-size: 1rem;
      border: 1px solid var(--border-color);
      border-radius: 4px;
    }
    button {
      background: var(--primary-color);
      color: var(--light-text);
      border: none;
      cursor: pointer;
      transition: background 0.3s;
    }
    button:hover {
      background: var(--primary-dark);
    }
    body.dark-mode button {
      color: #fff;
    }

    .section {
      margin-bottom: 30px;
    }

    /* Quiz Section */
    #quiz-section {
      position: relative;
    }
    #progress-indicator {
      margin-bottom: 15px;
      font-weight: 500;
      text-align: left;
      color: var(--text-color);
    }
    body.dark-mode #progress-indicator {
      color: #fff;
    }
    #quiz-container {
      text-align: left;
      margin-bottom: 20px;
      transition: opacity 0.4s ease;
    }

    /* Option Styling */
    .option {
      display: flex;
      align-items: center;
      padding: 15px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      margin-bottom: 10px;
      cursor: pointer;
      background: var(--card-background);
      transition: background 0.3s, border-color 0.3s;
      font-size: 1rem;
      color: var(--text-color);
    }
    .option:hover {
      background: #f0f0ff;
    }
    .option input[type="radio"] {
      margin-right: 15px;
      accent-color: var(--secondary-color);
      transform: scale(1.2);
    }
    body.dark-mode .option {
      background: #2a2a2a;
      border-color: #444;
      color: #fff;
    }
    body.dark-mode .option:hover {
      background: #333;
    }

    /* Navigation Buttons */
    .nav-buttons {
      display: flex;
      justify-content: space-between;
      gap: 15px;
      flex-wrap: wrap;
    }
    .nav-buttons button {
      flex: 1;
      min-width: 130px;
      padding: 15px;
      font-size: 1rem;
      border-radius: 6px;
    }
    .nav-buttons button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    body.dark-mode .nav-buttons button:disabled {
      background: #555;
    }

    /* Result & Analysis */
    #result-section, #analysis-container {
      text-align: center;
    }
    #quiz-result {
      font-size: 1.5rem;
      margin: 20px 0;
    }

    /* Leaderboard */
    #leaderboard {
      margin-top: 30px;
    }
    .leaderboard-title {
      font-size: 1.8rem;
      font-weight: 700;
      color: var(--primary-color);
      margin-bottom: 20px;
      text-align: center;
    }
    body.dark-mode .leaderboard-title {
      color: #fff;
    }
    .leaderboard-list {
      display: grid;
      grid-template-columns: 40px 1fr 1fr;
      gap: 10px;
      align-items: center;
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .leaderboard-item {
      display: contents;
      border-radius: 4px;
      margin-bottom: 6px;
      border: 1px solid var(--border-color);
    }
    .leaderboard-item:nth-child(even) {
      background: #fafafa;
    }
    body.dark-mode .leaderboard-item {
      border-color: #444;
    }
    body.dark-mode .leaderboard-item:nth-child(even) {
      background: #2a2a2a;
    }
    .leaderboard-rank {
      background: var(--primary-color);
      color: var(--light-text);
      padding: 8px;
      border-radius: 4px;
      text-align: center;
      font-weight: bold;
    }
    .leaderboard-username {
      font-weight: 600;
      padding: 8px;
      color: var(--text-color);
    }
    body.dark-mode .leaderboard-username {
      color: #fff;
    }
    .leaderboard-score {
      background: var(--primary-color);
      color: var(--light-text);
      padding: 8px 12px;
      border-radius: 4px;
      font-weight: 600;
      text-align: center;
    }

    /* Analysis Section */
    .analysis-header {
      display: flex;
      align-items: center;
      margin-bottom: 20px;
    }
    .analysis-back-arrow {
      background: transparent;
      color: var(--primary-color);
      border: none;
      font-size: 1.8rem;
      cursor: pointer;
      margin-right: 10px;
    }
    body.dark-mode .analysis-back-arrow {
      color: #fff;
    }
    .analysis-summary {
      background: var(--card-background);
      padding: 20px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      margin-bottom: 20px;
      box-shadow: var(--shadow);
      text-align: left;
      color: var(--text-color);
    }
    body.dark-mode .analysis-summary {
      background: #2a2a2a;
      border-color: #444;
      color: #fff;
    }
    .analysis-summary h2 {
      margin-bottom: 10px;
      font-size: 1.6rem;
      color: var(--primary-color);
    }
    body.dark-mode .analysis-summary h2 {
      color: #fff;
    }
    .analysis-summary p {
      margin: 5px 0;
      font-size: 1rem;
    }
    .analysis-item {
      background: var(--card-background);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      padding: 15px;
      margin-bottom: 15px;
      box-shadow: var(--shadow);
      text-align: left;
    }
    body.dark-mode .analysis-item {
      background: #2a2a2a;
      border-color: #444;
      color: #fff;
    }
    .analysis-question {
      font-weight: 600;
      margin-bottom: 10px;
    }
    .analysis-option {
      padding: 12px;
      margin: 8px 0;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      font-size: 1rem;
      color: var(--text-color);
    }
    .analysis-correct {
      color: green;
      border-color: green;
    }
    .analysis-user-correct {
      background: #d2f8d2;
    }
    .analysis-user-incorrect {
      background: #ffd6d6;
    }
    body.dark-mode .analysis-option {
      border-color: #444;
      color: #fff;
      background: #333;
    }
    body.dark-mode .analysis-user-correct {
      background: #385e38;
    }
    body.dark-mode .analysis-user-incorrect {
      background: #663b3b;
    }
    .analysis-explanation {
      margin-top: 10px;
      font-style: italic;
      color: var(--primary-color);
    }
    body.dark-mode .analysis-explanation {
      color: #bbb;
    }

    /* "Switch User" Link */
    .switch-user {
      text-align: right;
      margin-bottom: 10px;
    }
    .switch-user button {
      background: transparent;
      border: none;
      color: var(--primary-color);
      font-size: 0.9rem;
      cursor: pointer;
    }
    body.dark-mode .switch-user button {
      color: #fff;
    }

    /* Suggestion Section */
    #suggestion-section {
      margin-top: 20px;
      text-align: left;
    }
    #suggestion-section h3 {
      font-size: 1.4rem;
      margin-bottom: 10px;
      color: var(--primary-color);
    }
    body.dark-mode #suggestion-section h3 {
      color: #fff;
    }
    #suggestion-section textarea {
      width: 100%;
      padding: 12px;
      font-size: 1rem;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      resize: vertical;
      color: var(--text-color);
      background: var(--card-background);
    }
    body.dark-mode #suggestion-section textarea {
      background: #2a2a2a;
      border-color: #444;
      color: #fff;
    }

    /* Footer */
    .footer {
      text-align: center;
      font-size: 0.9rem;
      margin-top: 30px;
      color: var(--neutral-text);
    }
    body.dark-mode .footer {
      color: #bbb;
    }

    /* Responsive */
    @media (max-width: 600px) {
      .container {
        padding: 20px;
      }
      h2 {
        font-size: 1.6rem;
      }
      input, select, button, textarea {
        padding: 12px;
        font-size: 1rem;
      }
      .option {
        font-size: 1rem;
        padding: 12px;
      }
      .header h1 {
        font-size: 1.8rem;
      }
      .header .info {
        font-size: 0.9rem;
      }
      .leaderboard-list {
        grid-template-columns: 30px 1fr 1fr;
      }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="header">
    <h1>Quiz</h1>
    <span class="fullscreen-toggle" onclick="toggleFullScreen()">⛶</span>
    <span class="dark-toggle" onclick="toggleDarkMode()">🌙</span>
    <div class="info">
      <div id="candidate-name">Candidate: --</div>
      <div id="test-name">Test: --</div>
      <div id="timer">Time: 30:00</div>
    </div>
    <div id="timer-bar"></div>
  </div>

  <!-- Main Container -->
  <div class="container">
    <!-- Username Section -->
    <div id="username-section" class="section">
      <h2>Enter Your Name</h2>
      <input type="text" id="username" placeholder="Enter your name" aria-label="Enter your name" />
      <button onclick="saveUsername()">Continue</button>
    </div>

    <!-- Chapter Selection -->
    <div id="chapter-section" class="section" style="display: none;">
      <div class="switch-user">
        <button onclick="logoutUser()">Switch User</button>
      </div>
      <h2>Select Chapter</h2>
      <select id="chapter-list" aria-label="Select chapter">
        <option value="">-- Select Chapter --</option>
      </select>
      <button onclick="selectChapter()">Continue</button>
    </div>

    <!-- Quiz Section -->
    <div id="quiz-section" class="section" style="display: none;">
      <p id="progress-indicator"></p>
      <div id="quiz-container"></div>
      <div class="nav-buttons">
        <button id="prev-btn" onclick="previousQuestion()">Previous</button>
        <button id="next-btn" onclick="nextQuestion()">Save & Next</button>
      </div>
    </div>

    <!-- Result Section -->
    <div id="result-section" class="section" style="display: none;">
      <h2>Quiz Submitted!</h2>
      <div id="quiz-result"></div>
      <button onclick="showAnalysis()">Analysis</button>
      <button onclick="reattemptTest()">Reattempt Test</button>
      <div id="leaderboard"></div>
      <!-- Suggestion/Feedback Section -->
      <div id="suggestion-section">
        <h3>Have Suggestions?</h3>
        <textarea id="suggestion-input" placeholder="Enter your suggestions here..." rows="3"></textarea>
        <button onclick="submitSuggestion()">Submit Suggestion</button>
      </div>
    </div>

    <!-- Analysis Section -->
    <div id="analysis-container" class="section" style="display: none;">
      <div class="analysis-header">
        <button class="analysis-back-arrow" onclick="backToResults()">←</button>
        <h2 style="margin:0;">Overall Performance</h2>
      </div>
      <!-- We dynamically insert the rest of the summary and items here. -->
    </div>
  </div>

  

  <!-- Firebase SDKs and App Logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import {
      getFirestore,
      collection,
      collectionGroup,
      doc,
      getDocs,
      setDoc,
      query,
      where,
      orderBy,
      serverTimestamp,
      addDoc
    } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

    /* Replace with your Firebase config */
    const firebaseConfig = {
            apiKey: "AIzaSyDEU6CwuGyt_VZQ_8oO7nKeCh1GXybmkfk",
            authDomain: "quiz-ffdd5.firebaseapp.com",
            projectId: "quiz-ffdd5",
            storageBucket: "quiz-ffdd5.firebasestorage.app",
            messagingSenderId: "258308846737",
            appId: "1:258308846737:web:0c1d7871ab3af3f5077b30"
        };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let currentUser = null;
    let currentChapter = null;
    let questionsData = [];
    let userAnswers = [];
    let currentQuestionIndex = 0;
    let timerInterval;
    const totalTime = 30 * 60; // 30 minutes
    let timeLeft = totalTime;
    let quizStartTime = null;

    function loadSavedState() {
      const savedState = localStorage.getItem("quizState");
      if (savedState) {
        const state = JSON.parse(savedState);
        userAnswers = state.userAnswers || [];
        currentQuestionIndex = state.currentQuestionIndex || 0;
      }
    }

    function saveState() {
      localStorage.setItem("quizState", JSON.stringify({
        currentQuestionIndex,
        userAnswers
      }));
    }

    function toggleDarkMode() {
      document.body.classList.toggle("dark-mode");
      const darkToggleIcon = document.querySelector('.dark-toggle');
      darkToggleIcon.textContent = document.body.classList.contains("dark-mode") ? "☀️" : "🌙";
    }

    function toggleFullScreen() {
      if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen().catch(err => {
          alert(`Error enabling full-screen mode: ${err.message}`);
        });
      } else {
        document.exitFullscreen();
      }
    }

    function toTitleCase(str) {
      return str.replace(/\w\S*/g, (txt) =>
        txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase()
      );
    }

    function formatTime(seconds) {
      const m = Math.floor(seconds / 60);
      const s = seconds % 60;
      return `${m}:${s < 10 ? '0' + s : s}`;
    }

    async function saveUsername() {
      const usernameInput = document.getElementById("username").value.trim();
      if (!usernameInput) {
        alert("Please enter your name.");
        return;
      }
      currentUser = usernameInput;
      document.getElementById("candidate-name").innerText = `Candidate: ${currentUser}`;
      await setDoc(doc(db, "users", currentUser), { createdAt: new Date() }, { merge: true });
      localStorage.setItem("username", currentUser);
      document.getElementById("username-section").style.display = "none";
      document.getElementById("chapter-section").style.display = "block";
      loadChapters();
    }

    async function loadChapters() {
      const chapterList = document.getElementById("chapter-list");
      chapterList.innerHTML = '<option value="">-- Select Chapter --</option>';
      const querySnapshot = await getDocs(collection(db, "quizzes"));
      querySnapshot.forEach((docSnap) => {
        const option = document.createElement("option");
        option.value = docSnap.id;
        option.textContent = toTitleCase(docSnap.id);
        chapterList.appendChild(option);
      });
    }

    async function selectChapter() {
      currentChapter = document.getElementById("chapter-list").value;
      if (!currentChapter) {
        alert("Please select a chapter.");
        return;
      }
      document.getElementById("test-name").innerText = `Test: ${toTitleCase(currentChapter)}`;
      const attemptRef = doc(db, "users", currentUser, "attempts", currentChapter);
      await setDoc(attemptRef, { chapter: currentChapter, startedAt: new Date() }, { merge: true });
      document.getElementById("chapter-section").style.display = "none";
      document.getElementById("quiz-section").style.display = "block";
      quizStartTime = new Date();
      loadQuizQuestions();
      startTimer();
    }

    function startTimer() {
      timeLeft = totalTime;
      updateTimerDisplay();
      if (timerInterval) clearInterval(timerInterval);
      timerInterval = setInterval(() => {
        timeLeft--;
        if (timeLeft <= 0) {
          clearInterval(timerInterval);
          alert("Time's up! The quiz will now be submitted.");
          submitQuiz();
        }
        updateTimerDisplay();
      }, 1000);
    }

    function updateTimerDisplay() {
      const minutes = Math.floor(timeLeft / 60);
      const seconds = timeLeft % 60;
      document.getElementById("timer").innerText = `Time: ${minutes}:${seconds < 10 ? "0" + seconds : seconds}`;
      document.getElementById("timer-bar").style.width = ((timeLeft / totalTime) * 100) + "%";
      document.getElementById("timer").style.color = timeLeft < 300 ? "red" : "#fff";
    }

    async function loadQuizQuestions() {
  const questionsRef = collection(db, "quizzes", currentChapter, "questions");
  const querySnapshot = await getDocs(questionsRef);
  if (querySnapshot.empty) {
    document.getElementById("quiz-container").innerHTML = "<p>No questions available.</p>";
    document.querySelector(".nav-buttons")?.remove();
    return;
  }

  questionsData = [];
  querySnapshot.forEach((docSnap) => {
    questionsData.push(docSnap.data());
  });

  loadSavedState();
  if (!userAnswers || userAnswers.length !== questionsData.length) {
    userAnswers = new Array(questionsData.length).fill(null);
  }

  currentQuestionIndex = currentQuestionIndex >= questionsData.length ? 0 : currentQuestionIndex;

  // Initialize progress indicator
  document.getElementById("progress-indicator").innerText =
    `Question ${currentQuestionIndex + 1} of ${questionsData.length}`;

  showQuestion();
}

    function showQuestion() {
  if (currentQuestionIndex < 0 || currentQuestionIndex >= questionsData.length) {
    console.error("Invalid question index:", currentQuestionIndex);
    return;
  }

  const quizContainer = document.getElementById("quiz-container");
  quizContainer.style.opacity = 0; // Fade-out effect

  setTimeout(() => {
    const q = questionsData[currentQuestionIndex];
    let html = `<p>${renderTextOrImage(q.question)}</p>`; // Only render the question text

    // Render options
    q.options.forEach((option, index) => {
      const isChecked = userAnswers[currentQuestionIndex] === option;
      html += `
        <label class="option">
          <input type="radio" name="q" value="${option}" ${isChecked ? "checked" : ""}>
          <span>${renderTextOrImage(option)}</span>
        </label>`;
    });

    quizContainer.innerHTML = html;

    // Update progress indicator separately
    document.getElementById("progress-indicator").innerText =
      `Question ${currentQuestionIndex + 1} of ${questionsData.length}`;

    // Update navigation buttons
    document.getElementById("prev-btn").disabled = currentQuestionIndex === 0;
    document.getElementById("next-btn").innerText =
      currentQuestionIndex === questionsData.length - 1 ? "Submit" : "Save & Next";

    quizContainer.style.opacity = 1; // Fade-in effect
  }, 200);
}

    function nextQuestion() {
      const selectedElem = document.querySelector('input[name="q"]:checked');
      userAnswers[currentQuestionIndex] = selectedElem ? selectedElem.value : null;
      saveState();
      if (currentQuestionIndex === questionsData.length - 1) {
        if (confirm("Are you sure you want to finish the quiz?")) {
          submitQuiz();
        }
      } else {
        currentQuestionIndex++;
        saveState();
        showQuestion();
      }
    }

    function previousQuestion() {
      const selectedElem = document.querySelector('input[name="q"]:checked');
      userAnswers[currentQuestionIndex] = selectedElem ? selectedElem.value : null;
      saveState();
      if (currentQuestionIndex > 0) {
        currentQuestionIndex--;
        saveState();
        showQuestion();
      }
    }

    async function submitQuiz() {
      clearInterval(timerInterval);
      const selectedElem = document.querySelector('input[name="q"]:checked');
      userAnswers[currentQuestionIndex] = selectedElem ? selectedElem.value : null;
      let score = 0;
      const total = questionsData.length;
      let resultsDetail = [];
      for (let i = 0; i < total; i++) {
        const selectedAnswer = userAnswers[i] || "No Answer";
        const correctAnswer = questionsData[i].answer;
        const isCorrect = (selectedAnswer === correctAnswer);
        if (isCorrect) score++;
        resultsDetail.push({
          question: questionsData[i].question,
          options: questionsData[i].options,
          selectedAnswer: selectedAnswer,
          correctAnswer: correctAnswer,
          isCorrect: isCorrect,
          explanation: questionsData[i].explanation || ""
        });
      }
      const quizEndTime = new Date();
      const timeTaken = Math.floor((quizEndTime - quizStartTime) / 1000);
      const quizResult = {
        score: score,
        total: total,
        results: resultsDetail,
        chapter: currentChapter,
        timeTaken: timeTaken,
        submittedAt: serverTimestamp()
      };
      localStorage.setItem("quizResult", JSON.stringify(quizResult));
      localStorage.removeItem("quizState");
      const attemptRef = doc(db, "users", currentUser, "attempts", currentChapter);
      await setDoc(attemptRef, quizResult, { merge: true });
      document.getElementById("quiz-result").innerHTML = `<p>Your Score: ${score} out of ${total}</p>`;
      document.getElementById("quiz-section").style.display = "none";
      document.getElementById("result-section").style.display = "block";
      showLeaderboard();
    }

    async function showLeaderboard() {
      try {
        const leaderboardQuery = query(
          collectionGroup(db, "attempts"),
          where("chapter", "==", currentChapter),
          orderBy("score", "desc")
        );
        const snapshot = await getDocs(leaderboardQuery);
        if (snapshot.size === 0) {
          document.getElementById("leaderboard").innerHTML = "<p>No leaderboard data available.</p>";
          return;
        }
        let leaderboardHtml = `<div class="leaderboard-title">Leaderboard</div><ul class="leaderboard-list">`;
        let rank = 1;
        snapshot.forEach((docSnap) => {
          const username = docSnap.ref.parent.parent.id;
          const data = docSnap.data();
          const crown = (rank === 1) ? "👑" : "";
          leaderboardHtml += `
            <li class="leaderboard-item">
              <div class="leaderboard-rank">${rank}${crown}</div>
              <div class="leaderboard-username">${username}</div>
              <div class="leaderboard-score">${data.score}</div>
            </li>`;
          rank++;
        });
        leaderboardHtml += `</ul>`;
        document.getElementById("leaderboard").innerHTML = leaderboardHtml;
      } catch (error) {
        document.getElementById("leaderboard").innerHTML = `<p>Error loading leaderboard: ${error.message}</p>`;
      }
    }

    function renderTextOrImage(text) {
      const imageExtensions = [".png", ".jpg", ".jpeg", ".gif", ".webp", ".bmp"];
      const trimmed = text.trim();
      const lower = trimmed.toLowerCase();
      if ((lower.startsWith("http://") || lower.startsWith("https://"))) {
        if (imageExtensions.some(ext => lower.endsWith(ext))) {
          return `<img src="${trimmed}" alt="Image" style="max-width:100%; height:auto;">`;
        } else {
          return `<a href="${trimmed}" target="_blank">${trimmed}</a>`;
        }
      }
      return trimmed;
    }

    function showAnalysis() {
      const quizResultStr = localStorage.getItem("quizResult");
      if (!quizResultStr) {
        alert("No analysis data found!");
        return;
      }
      document.getElementById("username-section").style.display = "none";
      document.getElementById("chapter-section").style.display = "none";
      document.getElementById("quiz-section").style.display = "none";
      document.getElementById("result-section").style.display = "none";

      const quizResult = JSON.parse(quizResultStr);
      const analysisContainer = document.getElementById("analysis-container");
      analysisContainer.innerHTML = `
        <div class="analysis-header">
          <button class="analysis-back-arrow" onclick="backToResults()">←</button>
          <h2 style="margin:0;">Overall Performance</h2>
        </div>
      `;
      const percentage = ((quizResult.score / quizResult.total) * 100).toFixed(1);
      const avgTimePerQ = (quizResult.timeTaken / quizResult.total).toFixed(1);
      const summaryHtml = `
        <div class="analysis-summary">
          <p><strong>Score:</strong> ${quizResult.score} / ${quizResult.total}</p>
          <p><strong>Percentage:</strong> ${percentage}%</p>
          <p><strong>Time Taken:</strong> ${formatTime(quizResult.timeTaken)}</p>
          <p><strong>Avg Time per Question:</strong> ${avgTimePerQ} sec</p>
          <canvas id="resultChart" width="220" height="120"></canvas>
        </div>
      `;
      analysisContainer.innerHTML += summaryHtml;
      setTimeout(renderChart, 100);

      // Optionally a share button
      analysisContainer.innerHTML += `<button id="share-btn" onclick="shareResults()">Share Your Results</button>`;

      quizResult.results.forEach((item, index) => {
        let html = `
          <div class="analysis-item">
            <p class="analysis-question">Q${index + 1}: ${renderTextOrImage(item.question)}</p>`;
        if (item.explanation && item.explanation.trim() !== "") {
          html += `<p class="analysis-explanation"><strong>Explanation:</strong> ${renderTextOrImage(item.explanation)}</p>`;
        }
        item.options.forEach(opt => {
          let className = "analysis-option";
          if (opt === item.correctAnswer) className += " analysis-correct";
          if (opt === item.selectedAnswer) {
            className += item.isCorrect ? " analysis-user-correct" : " analysis-user-incorrect";
          }
          html += `<div class="${className}">${renderTextOrImage(opt)}</div>`;
        });
        html += `</div>`;
        analysisContainer.innerHTML += html;
      });

      analysisContainer.style.display = "block";
    }

    function renderChart() {
      const canvas = document.getElementById('resultChart');
      if (!canvas) return;
      const ctx = canvas.getContext('2d');
      const quizResult = JSON.parse(localStorage.getItem("quizResult"));
      const correct = parseInt(quizResult.score);
      const incorrect = parseInt(quizResult.total) - correct;
      new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['Correct', 'Incorrect'],
          datasets: [{
            data: [correct, incorrect],
            backgroundColor: ['#5c4ac7', '#e74c3c'],
            borderWidth: 1
          }]
        },
        options: {
          responsive: false,
          plugins: {
            legend: { position: 'bottom' }
          }
        }
      });
    }

    function shareResults() {
      const quizResultStr = localStorage.getItem("quizResult");
      if (!quizResultStr) return;
      const quizResult = JSON.parse(quizResultStr);
      const percentage = ((quizResult.score / quizResult.total) * 100).toFixed(1);
      const summary = `I scored ${quizResult.score} out of ${quizResult.total} (${percentage}%) on this Quiz!`;
      navigator.clipboard.writeText(summary).then(() => {
        alert("Results summary copied to clipboard!");
      });
    }

    function backToResults() {
      document.getElementById("analysis-container").style.display = "none";
      document.getElementById("result-section").style.display = "block";
    }

    function reattemptTest() {
      if (confirm("Your current test result will be removed once you reattempt the test. Continue?")) {
        localStorage.removeItem("quizResult");
        localStorage.removeItem("quizState");
        questionsData = [];
        userAnswers = [];
        currentQuestionIndex = 0;
        document.getElementById("result-section").style.display = "none";
        document.getElementById("analysis-container").style.display = "none";
        loadQuizQuestions();
        startTimer();
        document.getElementById("quiz-section").style.display = "block";
      }
    }

    async function submitSuggestion() {
      const suggestion = document.getElementById("suggestion-input").value.trim();
      if (!suggestion) {
        alert("Please enter a suggestion before submitting.");
        return;
      }
      try {
        await addDoc(collection(db, "suggestions"), {
          chapter: currentChapter,
          user: currentUser,
          suggestion: suggestion,
          timestamp: serverTimestamp()
        });
        alert("Thank you for your suggestion!");
        document.getElementById("suggestion-input").value = "";
      } catch (error) {
        alert("Error submitting suggestion: " + error.message);
      }
    }

    function logoutUser() {
      localStorage.removeItem("username");
      currentUser = null;
      document.getElementById("candidate-name").innerText = "Candidate: --";
      document.getElementById("chapter-section").style.display = "none";
      document.getElementById("username-section").style.display = "block";
    }

    document.addEventListener('DOMContentLoaded', () => {
      const storedUser = localStorage.getItem("username");
      if (storedUser) {
        currentUser = storedUser;
        document.getElementById("candidate-name").innerText = `Candidate: ${currentUser}`;
        document.getElementById("username-section").style.display = "none";
        document.getElementById("chapter-section").style.display = "block";
        loadChapters();
      }
    });

    window.saveUsername = saveUsername;
    window.selectChapter = selectChapter;
    window.nextQuestion = nextQuestion;
    window.previousQuestion = previousQuestion;
    window.submitQuiz = submitQuiz;
    window.showAnalysis = showAnalysis;
    window.backToResults = backToResults;
    window.toggleDarkMode = toggleDarkMode;
    window.logoutUser = logoutUser;
    window.shareResults = shareResults;
    window.reattemptTest = reattemptTest;
    window.submitSuggestion = submitSuggestion;
    window.toggleFullScreen = toggleFullScreen;
  </script>
</body>
</html>
